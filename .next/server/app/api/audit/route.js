"use strict";(()=>{var e={};e.id=701,e.ids=[701],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},29125:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>_,patchFetch:()=>v,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>E,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>q});var a={};r.r(a),r.d(a,{GET:()=>w});var i=r(95419),s=r(69108),n=r(99678),o=r(78070),u=r(81355),l=r(3205),d=r(3214),p=r(65256);let c=p.Km(["CREATE","UPDATE","DELETE","LOGIN"]),m=p.Ry({page:p.oQ.number().int().positive().default(1),pageSize:p.oQ.number().int().positive().max(100).default(20),action:c.optional(),userId:p.Z_().optional(),entity:p.Z_().optional(),startDate:p.Z_().optional(),endDate:p.Z_().optional()});var g=r(11013);async function w(e){try{let t=await (0,u.getServerSession)(l.L);if(!t?.user)return o.Z.json({error:"No autenticado"},{status:401});if(!(0,g.Pw)(t.user.role))return o.Z.json({error:"No tienes permisos para ver la auditor\xeda"},{status:403});let r=e.nextUrl.searchParams,a={};r.forEach((e,t)=>{a[t]=e});let i=m.parse(a),s={};i.action&&(s.action=i.action),i.userId&&(s.userId=i.userId),i.entity&&(s.entity=i.entity),(i.startDate||i.endDate)&&(s.timestamp={},i.startDate&&(s.timestamp.gte=new Date(i.startDate)),i.endDate&&(s.timestamp.lte=new Date(i.endDate)));let n=(i.page-1)*i.pageSize,p=i.pageSize,[c,w]=await Promise.all([d._.auditLog.findMany({where:s,include:{user:{select:{id:!0,name:!0,email:!0}},product:{select:{id:!0,name:!0}}},orderBy:{timestamp:"desc"},skip:n,take:p}),d._.auditLog.count({where:s})]);return o.Z.json({logs:c,pagination:{page:i.page,pageSize:i.pageSize,total:w,totalPages:Math.ceil(w/i.pageSize)}})}catch(e){return console.error("Error fetching audit logs:",e),o.Z.json({error:"Error al obtener logs de auditor\xeda"},{status:500})}}let f=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/audit/route",pathname:"/api/audit",filename:"route",bundlePath:"app/api/audit/route"},resolvedPagePath:"E:\\proyectos_windsurf\\catalogo-sunass\\app\\api\\audit\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:E,headerHooks:h,staticGenerationBailout:q}=f,_="/api/audit/route";function v(){return(0,n.patchFetch)({serverHooks:E,staticGenerationAsyncStorage:x})}},3205:(e,t,r)=>{r.d(t,{L:()=>l});var a=r(86485),i=r(10375),s=r(54896),n=r(3214),o=r(6521),u=r.n(o);let l={adapter:(0,s.N)(n._),providers:[(0,a.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email y contrase\xf1a son requeridos");let t=await n._.user.findUnique({where:{email:e.email}});if(!t||!t.password||!await u().compare(e.password,t.password))throw Error("Credenciales inv\xe1lidas");return await n._.auditLog.create({data:{entity:"User",entityId:t.id,action:"LOGIN",userId:t.id}}),{id:t.id,email:t.email,name:t.name,role:t.role}}}),(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||"",authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],callbacks:{async signIn({user:e,account:t,profile:r}){if(t?.provider==="google"){let t=e.email;if(!t)return!1;let r=await n._.user.findUnique({where:{email:t}});r||(process.env.ALLOWED_DOMAIN,t.split("@")[1],r=await n._.user.create({data:{email:t,name:e.name||t.split("@")[0],role:"USER",emailVerified:new Date}})),await n._.auditLog.create({data:{entity:"User",entityId:r.id,action:"LOGIN",userId:r.id}})}return!0},session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.role=t.role),e),async jwt({token:e,user:t}){if(t)e.id=t.id,e.role=t.role;else if(e.email){let t=await n._.user.findUnique({where:{email:e.email},select:{id:!0,role:!0}});t&&(e.id=t.id,e.role=t.role)}return e}},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},11013:(e,t,r)=>{function a(e,t,r){return"ADMIN"===e}function i(e,t,r){return"ADMIN"===e||t===r}function s(e){return"ADMIN"===e}function n(e){return"ADMIN"===e}r.d(t,{Ct:()=>i,Pw:()=>s,qi:()=>n,rn:()=>a})},3214:(e,t,r)=>{r.d(t,{_:()=>i});var a=r(53524);let i=globalThis.prisma??new a.PrismaClient}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,753,206,980],()=>r(29125));module.exports=a})();