"use strict";(()=>{var e={};e.id=684,e.ids=[684],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},35575:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>w,originalPathname:()=>E,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>f});var a={};r.r(a),r.d(a,{GET:()=>u,POST:()=>m});var i=r(95419),s=r(69108),o=r(99678),n=r(78070),l=r(81355),p=r(3205),c=r(3214),d=r(21855);async function u(e){try{let t=await (0,l.getServerSession)(p.L),r=e.nextUrl.searchParams,a={};r.forEach((e,t)=>{"tags"===t?(a.tags||(a.tags=[]),a.tags.push(e)):a[t]=e});let i=d.hd.parse(a),s={};t||(s.visibility="PUBLIC"),i.q&&(s.OR=[{name:{contains:i.q}},{description:{contains:i.q}},{tags:{some:{tag:{name:{contains:i.q}}}}}]),i.type&&(s.type=i.type),i.status&&(s.status=i.status),i.visibility&&t&&(s.visibility=i.visibility),i.eps&&(s.eps={contains:i.eps}),i.region&&(s.region={contains:i.region}),i.district&&(s.district={contains:i.district}),i.topic&&(s.topic={contains:i.topic}),i.period&&(s.period={contains:i.period}),i.owner&&(s.owner={contains:i.owner}),i.tags&&Array.isArray(i.tags)&&i.tags.length>0&&(s.tags={some:{tag:{name:{in:i.tags}}}});let o=(i.page-1)*i.pageSize,u=i.pageSize,m={};m[i.sortBy]=i.sortOrder;let[g,y]=await Promise.all([c._.product.findMany({where:s,include:{tags:{include:{tag:!0}},createdBy:{select:{id:!0,name:!0,email:!0}}},orderBy:m,skip:o,take:u}),c._.product.count({where:s})]);return n.Z.json({products:g,pagination:{page:i.page,pageSize:i.pageSize,total:y,totalPages:Math.ceil(y/i.pageSize)}})}catch(e){return console.error("Error fetching products:",e),n.Z.json({error:"Error al obtener productos"},{status:500})}}async function m(e){try{let t=await (0,l.getServerSession)(p.L);if(!t?.user)return n.Z.json({error:"No autenticado"},{status:401});let r=await e.json(),a=d.Iy.parse(r),i=a.tags||[],s=await Promise.all(i.map(async e=>await c._.tag.upsert({where:{name:e},create:{name:e},update:{}}))),o=await c._.product.create({data:{name:a.name,type:a.type,description:a.description,url:a.url||null,owner:a.owner,status:a.status,visibility:a.visibility,eps:a.eps,region:a.region,district:a.district,topic:a.topic,period:a.period,source:a.source,createdById:t.user.id,tags:{create:s.map(e=>({tag:{connect:{id:e.id}}}))}},include:{tags:{include:{tag:!0}},createdBy:{select:{id:!0,name:!0,email:!0}}}});return await c._.auditLog.create({data:{entity:"Product",entityId:o.id,action:"CREATE",userId:t.user.id,productId:o.id,diff:JSON.stringify({created:!0})}}),n.Z.json(o,{status:201})}catch(e){if(console.error("Error creating product:",e),e instanceof Error)return n.Z.json({error:e.message},{status:400});return n.Z.json({error:"Error al crear producto"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:"app/api/products/route"},resolvedPagePath:"E:\\proyectos_windsurf\\catalogo-sunass\\app\\api\\products\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:y,staticGenerationAsyncStorage:x,serverHooks:_,headerHooks:w,staticGenerationBailout:f}=g,E="/api/products/route";function h(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:x})}},3205:(e,t,r)=>{r.d(t,{L:()=>p});var a=r(86485),i=r(10375),s=r(54896),o=r(3214),n=r(6521),l=r.n(n);let p={adapter:(0,s.N)(o._),providers:[(0,a.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email y contrase\xf1a son requeridos");let t=await o._.user.findUnique({where:{email:e.email}});if(!t||!t.password||!await l().compare(e.password,t.password))throw Error("Credenciales inv\xe1lidas");return await o._.auditLog.create({data:{entity:"User",entityId:t.id,action:"LOGIN",userId:t.id}}),{id:t.id,email:t.email,name:t.name,role:t.role}}}),(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||"",authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],callbacks:{async signIn({user:e,account:t,profile:r}){if(t?.provider==="google"){let t=e.email;if(!t)return!1;let r=await o._.user.findUnique({where:{email:t}});r||(process.env.ALLOWED_DOMAIN,t.split("@")[1],r=await o._.user.create({data:{email:t,name:e.name||t.split("@")[0],role:"USER",emailVerified:new Date}})),await o._.auditLog.create({data:{entity:"User",entityId:r.id,action:"LOGIN",userId:r.id}})}return!0},session:async({session:e,token:t})=>(t&&e.user&&(e.user.id=t.id,e.user.role=t.role),e),async jwt({token:e,user:t}){if(t)e.id=t.id,e.role=t.role;else if(e.email){let t=await o._.user.findUnique({where:{email:e.email},select:{id:!0,role:!0}});t&&(e.id=t.id,e.role=t.role)}return e}},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},3214:(e,t,r)=>{r.d(t,{_:()=>i});var a=r(53524);let i=globalThis.prisma??new a.PrismaClient},21855:(e,t,r)=>{r.d(t,{Iy:()=>n,hd:()=>l});var a=r(65256);let i=a.Km(["DASHBOARD","FORM","REPORT","TOOL","OTHER"]),s=a.Km(["DRAFT","ACTIVE","DEPRECATED"]),o=a.Km(["PUBLIC","INTERNAL"]),n=a.Ry({name:a.Z_().min(1,"El nombre es requerido").max(200,"M\xe1ximo 200 caracteres"),type:i,description:a.Z_().max(2e3,"M\xe1ximo 2000 caracteres").optional().nullable(),url:a.Z_().url("Debe ser una URL v\xe1lida").regex(/^https?:\/\//,"La URL debe comenzar con http:// o https://").optional().nullable().or(a.i0("")),owner:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),status:s,visibility:o,eps:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),region:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),district:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),topic:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),period:a.Z_().max(50,"M\xe1ximo 50 caracteres").optional().nullable(),source:a.Z_().max(200,"M\xe1ximo 200 caracteres").optional().nullable(),tags:a.IX(a.Z_()).optional()}),l=a.Ry({q:a.Z_().optional(),page:a.oQ.number().int().positive().default(1),pageSize:a.oQ.number().int().positive().max(100).default(20),type:i.optional(),status:s.optional(),visibility:o.optional(),eps:a.Z_().optional(),region:a.Z_().optional(),district:a.Z_().optional(),topic:a.Z_().optional(),period:a.Z_().optional(),owner:a.Z_().optional(),tags:a.G0([a.Z_(),a.IX(a.Z_())]).optional(),sortBy:a.Km(["updatedAt","name","status","createdAt"]).default("updatedAt"),sortOrder:a.Km(["asc","desc"]).default("desc")})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[638,753,206,980],()=>r(35575));module.exports=a})();