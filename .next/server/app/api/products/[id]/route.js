"use strict";(()=>{var e={};e.id=898,e.ids=[898],e.modules={53524:e=>{e.exports=require("@prisma/client")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},92613:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>E,originalPathname:()=>h,patchFetch:()=>I,requestAsyncStorage:()=>w,routeModule:()=>g,serverHooks:()=>_,staticGenerationAsyncStorage:()=>x,staticGenerationBailout:()=>Z});var a={};t.r(a),t.d(a,{DELETE:()=>f,GET:()=>m,PATCH:()=>y});var i=t(95419),o=t(69108),s=t(99678),n=t(78070),u=t(81355),d=t(3205),l=t(3214),c=t(21855),p=t(11013);async function m(e,{params:r}){try{let e=await (0,u.getServerSession)(d.L),t=await l._.product.findUnique({where:{id:r.id},include:{tags:{include:{tag:!0}},createdBy:{select:{id:!0,name:!0,email:!0,role:!0}}}});if(!t)return n.Z.json({error:"Producto no encontrado"},{status:404});if("INTERNAL"===t.visibility&&!e)return n.Z.json({error:"No autorizado"},{status:403});return n.Z.json(t)}catch(e){return console.error("Error fetching product:",e),n.Z.json({error:"Error al obtener producto"},{status:500})}}async function y(e,{params:r}){try{let t=await (0,u.getServerSession)(d.L);if(!t?.user)return n.Z.json({error:"No autenticado"},{status:401});let a=await l._.product.findUnique({where:{id:r.id}});if(!a)return n.Z.json({error:"Producto no encontrado"},{status:404});if(!(0,p.Ct)(t.user.role,a.createdById,t.user.id))return n.Z.json({error:"No tienes permisos para editar este producto"},{status:403});let i=await e.json(),o=c.Iy.parse(i),s={...a},m=o.tags||[],y=await Promise.all(m.map(async e=>await l._.tag.upsert({where:{name:e},create:{name:e},update:{}}))),f=await l._.product.update({where:{id:r.id},data:{name:o.name,type:o.type,description:o.description,url:o.url||null,owner:o.owner,status:o.status,visibility:o.visibility,eps:o.eps,region:o.region,district:o.district,topic:o.topic,period:o.period,source:o.source,tags:{deleteMany:{},create:y.map(e=>({tag:{connect:{id:e.id}}}))}},include:{tags:{include:{tag:!0}},createdBy:{select:{id:!0,name:!0,email:!0}}}});return await l._.auditLog.create({data:{entity:"Product",entityId:f.id,action:"UPDATE",userId:t.user.id,productId:f.id,diff:JSON.stringify({before:s,after:f})}}),n.Z.json(f)}catch(e){if(console.error("Error updating product:",e),e instanceof Error)return n.Z.json({error:e.message},{status:400});return n.Z.json({error:"Error al actualizar producto"},{status:500})}}async function f(e,{params:r}){try{let e=await (0,u.getServerSession)(d.L);if(!e?.user)return n.Z.json({error:"No autenticado"},{status:401});let t=await l._.product.findUnique({where:{id:r.id}});if(!t)return n.Z.json({error:"Producto no encontrado"},{status:404});if(!(0,p.rn)(e.user.role,t.createdById,e.user.id))return n.Z.json({error:"No tienes permisos para eliminar productos. Solo los administradores pueden hacerlo."},{status:403});let a={...t};return await l._.product.delete({where:{id:r.id}}),await l._.auditLog.create({data:{entity:"Product",entityId:r.id,action:"DELETE",userId:e.user.id,diff:JSON.stringify({deleted:a})}}),n.Z.json({success:!0})}catch(e){return console.error("Error deleting product:",e),n.Z.json({error:"Error al eliminar producto"},{status:500})}}let g=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/products/[id]/route",pathname:"/api/products/[id]",filename:"route",bundlePath:"app/api/products/[id]/route"},resolvedPagePath:"E:\\proyectos_windsurf\\catalogo-sunass\\app\\api\\products\\[id]\\route.ts",nextConfigOutput:"standalone",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:x,serverHooks:_,headerHooks:E,staticGenerationBailout:Z}=g,h="/api/products/[id]/route";function I(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:x})}},3205:(e,r,t)=>{t.d(r,{L:()=>d});var a=t(86485),i=t(10375),o=t(54896),s=t(3214),n=t(6521),u=t.n(n);let d={adapter:(0,o.N)(s._),providers:[(0,a.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)throw Error("Email y contrase\xf1a son requeridos");let r=await s._.user.findUnique({where:{email:e.email}});if(!r||!r.password||!await u().compare(e.password,r.password))throw Error("Credenciales inv\xe1lidas");return await s._.auditLog.create({data:{entity:"User",entityId:r.id,action:"LOGIN",userId:r.id}}),{id:r.id,email:r.email,name:r.name,role:r.role}}}),(0,i.Z)({clientId:process.env.GOOGLE_CLIENT_ID||"",clientSecret:process.env.GOOGLE_CLIENT_SECRET||"",authorization:{params:{prompt:"consent",access_type:"offline",response_type:"code"}}})],callbacks:{async signIn({user:e,account:r,profile:t}){if(r?.provider==="google"){let r=e.email;if(!r)return!1;let t=await s._.user.findUnique({where:{email:r}});t||(process.env.ALLOWED_DOMAIN,r.split("@")[1],t=await s._.user.create({data:{email:r,name:e.name||r.split("@")[0],role:"USER",emailVerified:new Date}})),await s._.auditLog.create({data:{entity:"User",entityId:t.id,action:"LOGIN",userId:t.id}})}return!0},session:async({session:e,token:r})=>(r&&e.user&&(e.user.id=r.id,e.user.role=r.role),e),async jwt({token:e,user:r}){if(r)e.id=r.id,e.role=r.role;else if(e.email){let r=await s._.user.findUnique({where:{email:e.email},select:{id:!0,role:!0}});r&&(e.id=r.id,e.role=r.role)}return e}},pages:{signIn:"/login"},session:{strategy:"jwt"},secret:process.env.NEXTAUTH_SECRET}},11013:(e,r,t)=>{function a(e,r,t){return"ADMIN"===e}function i(e,r,t){return"ADMIN"===e||r===t}function o(e){return"ADMIN"===e}function s(e){return"ADMIN"===e}t.d(r,{Ct:()=>i,Pw:()=>o,qi:()=>s,rn:()=>a})},3214:(e,r,t)=>{t.d(r,{_:()=>i});var a=t(53524);let i=globalThis.prisma??new a.PrismaClient},21855:(e,r,t)=>{t.d(r,{Iy:()=>n,hd:()=>u});var a=t(65256);let i=a.Km(["DASHBOARD","FORM","REPORT","TOOL","OTHER"]),o=a.Km(["DRAFT","ACTIVE","DEPRECATED"]),s=a.Km(["PUBLIC","INTERNAL"]),n=a.Ry({name:a.Z_().min(1,"El nombre es requerido").max(200,"M\xe1ximo 200 caracteres"),type:i,description:a.Z_().max(2e3,"M\xe1ximo 2000 caracteres").optional().nullable(),url:a.Z_().url("Debe ser una URL v\xe1lida").regex(/^https?:\/\//,"La URL debe comenzar con http:// o https://").optional().nullable().or(a.i0("")),owner:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),status:o,visibility:s,eps:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),region:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),district:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),topic:a.Z_().max(100,"M\xe1ximo 100 caracteres").optional().nullable(),period:a.Z_().max(50,"M\xe1ximo 50 caracteres").optional().nullable(),source:a.Z_().max(200,"M\xe1ximo 200 caracteres").optional().nullable(),tags:a.IX(a.Z_()).optional()}),u=a.Ry({q:a.Z_().optional(),page:a.oQ.number().int().positive().default(1),pageSize:a.oQ.number().int().positive().max(100).default(20),type:i.optional(),status:o.optional(),visibility:s.optional(),eps:a.Z_().optional(),region:a.Z_().optional(),district:a.Z_().optional(),topic:a.Z_().optional(),period:a.Z_().optional(),owner:a.Z_().optional(),tags:a.G0([a.Z_(),a.IX(a.Z_())]).optional(),sortBy:a.Km(["updatedAt","name","status","createdAt"]).default("updatedAt"),sortOrder:a.Km(["asc","desc"]).default("desc")})}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[638,753,206,980],()=>t(92613));module.exports=a})();